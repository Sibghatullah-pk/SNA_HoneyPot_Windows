{% extends "base.html" %}

{% block title %}Dashboard - Sentinel Honeypot{% endblock %}

{% block content %}
<div class="dashboard">
    <h2>Security Dashboard</h2>
    
    <!-- Control Panel -->
    <div class="control-panel">
        <h3>Honeypot Control</h3>
        <div class="controls">
            <button id="startBtn" class="btn btn-success" onclick="fallbackStart()">Start Honeypot</button>
            <button id="stopBtn" class="btn btn-danger" onclick="fallbackStop()">Stop Honeypot</button>
            <button id="clearBtn" class="btn btn-warning" style="background:#ff9800;" onclick="fallbackClear()">Clear Stats</button>
            <span id="status" class="status-badge">Stopped</span>
        </div>
    </div>
    
    <!-- Team Attack Info -->
    <div class="attack-info-panel">
        <div id="attackInfo" class="attack-hero-grid">
            <div class="attack-hero-left">
                <h3>üéØ Team Attack Guide</h3>
                <div class="hero-row">
                    <div>
                        <h4>Target IP Address:</h4>
                        <p id="targetIP" class="hero-ip">Loading...</p>
                    </div>
                    <div>
                        <h4>Ports to Attack:</h4>
                        <div id="portsList" class="hero-ports">
                            <span class="port">2222</span>(SSH) | 
                            <span class="port">2323</span>(Telnet) | 
                            <span class="port">8000</span>(HTTP) | 
                            <span class="port">8443</span>(HTTPS) | 
                            <span class="port">33060</span>(MySQL) | 
                            <span class="port">8080</span>(Proxy) |
                            <span class="port">2121</span>(FTP)
                        </div>
                    </div>
                </div>
                <div class="hero-commands">
                    <h4>Quick Attack Commands:</h4>
                    <div class="commands-row">
                        <code id="attackCommands" class="commands-code">nmap -sV -p 2222,2323,8000,8443,33060,8080,2121 &lt;TARGET_IP&gt;
telnet &lt;TARGET_IP&gt; 2323
curl http://&lt;TARGET_IP&gt;:8000
ssh root@&lt;TARGET_IP&gt; -p 2222
nc &lt;TARGET_IP&gt; 2222</code>
                        <button id="copyCommands" class="copy-btn" title="Copy commands">Copy</button>
                    </div>
                </div>
            </div>
            <div class="attack-hero-right" aria-hidden="true">
                <!-- decorative honeycomb/illustration -->
                <svg class="hero-illustration" viewBox="0 0 300 140" xmlns="http://www.w3.org/2000/svg" role="img">
                    <defs>
                        <linearGradient id="g1" x1="0" x2="1">
                            <stop offset="0" stop-color="#ffd166"/>
                            <stop offset="1" stop-color="#ff6b6b"/>
                        </linearGradient>
                    </defs>
                    <g fill="url(#g1)" opacity="0.12">
                        <rect x="10" y="10" width="60" height="40" rx="6" />
                        <rect x="80" y="20" width="60" height="40" rx="6" />
                        <rect x="150" y="10" width="60" height="40" rx="6" />
                        <rect x="40" y="60" width="60" height="40" rx="6" />
                        <rect x="110" y="60" width="60" height="40" rx="6" />
                    </g>
                </svg>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üéØ</div>
            <div class="stat-info">
                <h4>Total Attacks</h4>
                <p class="stat-value" id="totalAttacks">0</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üåê</div>
            <div class="stat-info">
                <h4>Unique IPs</h4>
                <p class="stat-value" id="uniqueIps">0</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üîç</div>
            <div class="stat-info">
                <h4>Port Scans</h4>
                <p class="stat-value" id="portScans">0</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">‚ö†Ô∏è</div>
            <div class="stat-info">
                <h4>Connections</h4>
                <p class="stat-value" id="connections">0</p>
            </div>
        </div>
    </div>

    <!-- Recent Attacks -->
    <div class="recent-attacks">
        <h3>Recent Attack Activity</h3>
        <div class="table-container">
            <table id="attacksTable">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Source IP</th>
                        <th>Target Port</th>
                        <th>Service</th>
                        <th>Type</th>
                    </tr>
                </thead>
                <tbody id="attacksBody">
                    <tr class="no-data-row">
                        <td colspan="5" data-label="Info">
                            <div class="empty-illustration">
                                <svg viewBox="0 0 64 48" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true">
                                    <rect x="2" y="8" width="60" height="32" rx="4" fill="rgba(0,217,255,0.06)" stroke="rgba(0,217,255,0.12)"/>
                                    <circle cx="18" cy="24" r="4" fill="rgba(0,217,255,0.12)"/>
                                    <rect x="30" y="18" width="22" height="2" fill="rgba(0,217,255,0.08)"/>
                                    <rect x="30" y="22" width="16" height="2" fill="rgba(0,217,255,0.04)"/>
                                </svg>
                                <div>
                                    <div style="font-weight:700;color:var(--muted);">No attack data yet</div>
                                    <div class="small">The system is ready ‚Äî generate traffic or open trap endpoints to see activity</div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
            <div id="attacksPager" class="pagination" aria-label="Attacks pagination"></div>
        </div>
    </div>

    <!-- Attack Chart -->
    <div class="chart-container">
        <h3>Attack Timeline</h3>
        <canvas id="attackChart"></canvas>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Inline fallbacks invoked only when dashboard JS didn't initialize.
function fallbackStart(){
    if(window.__dashboard_js_loaded) return;
    if(!confirm('Start honeypot (fallback)?')) return;
    fetch('/api/start_honeypot',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({})})
        .then(r=>r.json()).then(d=>alert(d.message||JSON.stringify(d))).catch(e=>alert('Error: '+e));
}
function fallbackStop(){
    if(window.__dashboard_js_loaded) return;
    if(!confirm('Stop honeypot (fallback)?')) return;
    fetch('/api/stop_honeypot',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({})})
        .then(r=>r.json()).then(d=>alert(d.message||JSON.stringify(d))).catch(e=>alert('Error: '+e));
}
function fallbackClear(){
    if(window.__dashboard_js_loaded) return;
    if(!confirm('Clear stats (fallback)?')) return;
    fetch('/api/clear_stats',{method:'POST',headers:{'Content-Type':'application/json'}})
        .then(r=>r.json()).then(d=>alert(d.message||JSON.stringify(d))).catch(e=>alert('Error: '+e));
}
</script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}?v=2"></script>
<script>
// Inline fallback renderer: ensures data appears even if dashboard.js fails
(function(){
    function buildRows(recent) {
        if(!recent || recent.length===0) return '<tr><td colspan="5" class="no-data" data-label="Info">No attacks detected yet</td></tr>';
        return recent.slice().reverse().map(a=>{
            const t = a.timestamp || a.time || '';
            return `<tr>`+
                `<td data-label="Time">${t}</td>`+
                `<td data-label="Source IP"><span class="ip-text">${a.source_ip||'Unknown'}</span> <button class="copy-btn" data-clip="${a.source_ip||''}">Copy</button></td>`+
                `<td data-label="Target Port">${a.target_port||'N/A'}</td>`+
                `<td data-label="Service">${a.service||'Unknown'}</td>`+
                `<td data-label="Type"><span class="badge ${a.type||''}">${a.type||'Unknown'}</span></td>`+
            `</tr>`;
        }).join('');
    }

    function renderStats(data){
        try{
            document.getElementById('totalAttacks').textContent = data.total_attacks || 0;
            document.getElementById('uniqueIps').textContent = data.unique_ips || 0;
            document.getElementById('portScans').textContent = data.port_scans || 0;
            document.getElementById('connections').textContent = data.connection_attempts || 0;

            const tbody = document.getElementById('attacksBody');
            tbody.innerHTML = buildRows(data.recent_attacks || []);

            // attach simple copy handlers
            tbody.querySelectorAll('.copy-btn[data-clip]').forEach(b=>{
                b.addEventListener('click', ()=>{ navigator.clipboard.writeText(b.getAttribute('data-clip')||''); b.textContent='Copied'; setTimeout(()=>b.textContent='Copy',900); });
            });

            // populate chart
            try{
                const recent = (data.recent_attacks||[]).slice().reverse();
                const labels = recent.map(a=>{ try{ return new Date(a.timestamp).toLocaleTimeString(); }catch(e){ return a.timestamp||''; }}).slice(-20);
                const values = recent.map((_,i)=>i+1).slice(-20);
                if(window.attackChart && attackChart.data){
                    attackChart.data.labels = labels;
                    attackChart.data.datasets[0].data = values;
                    attackChart.update();
                } else if(typeof Chart !== 'undefined'){
                    const ctx = document.getElementById('attackChart').getContext('2d');
                    window.__fallbackAttackChart = new Chart(ctx, { type:'line', data:{ labels: labels, datasets:[{ label:'Attacks Over Time', data: values, borderColor:'#00d9ff', tension:0.3, fill:false }] }, options:{ responsive:true, maintainAspectRatio:false } });
                }
            }catch(e){console.warn('chart render failed',e)}
        }catch(e){console.warn('renderStats error',e)}
    }

    function refresh(){ fetch('/api/stats').then(r=>r.json()).then(renderStats).catch(e=>console.warn('stats fetch failed',e)); }
    refresh();
    setInterval(refresh,5000);
})();
</script>
{% endblock %}
