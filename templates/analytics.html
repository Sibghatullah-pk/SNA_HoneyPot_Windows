{% extends "base.html" %}

{% block title %}Analytics - Sentinel Honeypot{% endblock %}

{% block content %}
<div class="analytics">
    <h2>Security Analytics</h2>
    
    <div class="analytics-grid">
        <div class="chart-box">
            <h3>Attacks by Port</h3>
            <canvas id="portChart"></canvas>
        </div>
        
        <div class="chart-box">
            <h3>Attack Types</h3>
            <canvas id="typeChart"></canvas>
        </div>
        
        <div class="chart-box">
            <h3>Hourly Attack Pattern</h3>
            <canvas id="timeChart"></canvas>
        </div>
        
        <div class="chart-box">
            <h3>Top Attackers</h3>
            <div id="topAttackers" class="list-container">
                <p>Loading...</p>
            </div>
        </div>
    </div>

    <div class="network-scanner">
        <h3>Network Scanner</h3>
        <div class="scanner-controls">
            <input type="text" id="scanTarget" placeholder="Enter IP or network (e.g., 192.168.1.0/24)" value="127.0.0.1">
            <button id="scanBtn" class="btn btn-primary">Scan Network</button>
        </div>
        <div id="scanResults" class="results-container">
            <p>Enter a target and click Scan to begin</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Port Chart
const portCtx = document.getElementById('portChart').getContext('2d');
const portChart = new Chart(portCtx, {
    type: 'bar',
    data: {
        labels: ['22', '23', '80', '443', '3306', '8080'],
        datasets: [{
            label: 'Attacks',
            data: [0, 0, 0, 0, 0, 0],
            backgroundColor: '#36a2eb'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: { color: '#e0e0e0' }
            },
            x: {
                ticks: { color: '#e0e0e0' }
            }
        },
        plugins: {
            legend: { labels: { color: '#e0e0e0' } }
        }
    }
});

// Type Chart
const typeCtx = document.getElementById('typeChart').getContext('2d');
const typeChart = new Chart(typeCtx, {
    type: 'pie',
    data: {
        labels: ['Connection Attempts', 'Port Scans', 'Other'],
        datasets: [{
            data: [0, 0, 0],
            backgroundColor: ['#ff6384', '#36a2eb', '#ffce56']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: { color: '#e0e0e0' }
            }
        }
    }
});

// Time Chart
const timeCtx = document.getElementById('timeChart').getContext('2d');
const timeChart = new Chart(timeCtx, {
    type: 'line',
    data: {
        labels: Array.from({length: 24}, (_, i) => i + ':00'),
        datasets: [{
            label: 'Attacks per Hour',
            data: new Array(24).fill(0),
            borderColor: '#4bc0c0',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: { color: '#e0e0e0' }
            },
            x: {
                ticks: { color: '#e0e0e0' }
            }
        },
        plugins: {
            legend: { labels: { color: '#e0e0e0' } }
        }
    }
});

// Network Scanner
document.getElementById('scanBtn').addEventListener('click', function() {
    const target = document.getElementById('scanTarget').value;
    const results = document.getElementById('scanResults');
    
    results.innerHTML = '<p class="loading">Scanning... Please wait</p>';
    this.disabled = true;
    
    fetch('/api/scan_network', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ target: target })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            displayScanResults(data.results);
        } else {
            results.innerHTML = `<p class="error">Error: ${data.message}</p>`;
        }
        this.disabled = false;
    })
    .catch(error => {
        results.innerHTML = `<p class="error">Scan failed: ${error}</p>`;
        this.disabled = false;
    });
});

function displayScanResults(results) {
    const container = document.getElementById('scanResults');
    let html = '<div class="scan-result">';
    
    if (results.open_ports) {
        html += `<h4>Host: ${results.host}</h4>`;
        if (results.open_ports.length > 0) {
            html += '<ul>';
            results.open_ports.forEach(port => {
                html += `<li>Port ${port.port} (${port.service}) - <span class="open">OPEN</span></li>`;
            });
            html += '</ul>';
        } else {
            html += '<p>No open ports found</p>';
        }
    }
    
    html += '</div>';
    container.innerHTML = html;
}

// Load statistics
function loadStats() {
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            // Update charts with real data
            updateChartsWithData(data);
        });
}

function updateChartsWithData(data) {
    // Update based on recent attacks
    if (data.recent_attacks && data.recent_attacks.length > 0) {
        const portCounts = {};
        const typeCounts = {};
        
        data.recent_attacks.forEach(attack => {
            portCounts[attack.target_port] = (portCounts[attack.target_port] || 0) + 1;
            typeCounts[attack.type] = (typeCounts[attack.type] || 0) + 1;
        });
        
        // Update port chart
        const ports = Object.keys(portCounts);
        const portData = Object.values(portCounts);
        if (ports.length > 0) {
            portChart.data.labels = ports;
            portChart.data.datasets[0].data = portData;
            portChart.update();
        }
        
        // Update type chart
        typeChart.data.datasets[0].data = [
            typeCounts['connection_attempt'] || 0,
            typeCounts['port_scan'] || 0,
            typeCounts['other'] || 0
        ];
        typeChart.update();
    }
}

// Load stats every 5 seconds
setInterval(loadStats, 5000);
loadStats();
</script>
{% endblock %}
